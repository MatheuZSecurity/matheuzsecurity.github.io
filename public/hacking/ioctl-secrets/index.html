<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Ioctl Secrets Writeup | 0xMatheuZ</title>
<meta name="keywords" content="CTF">
<meta name="description" content="Solving an easy reversing challenge from rootkit researchers.">
<meta name="author" content="0xMatheuZ">
<link rel="canonical" href="http://localhost:1313/hacking/ioctl-secrets/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/hacking/ioctl-secrets/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Ioctl Secrets Writeup" />
<meta property="og:description" content="Solving an easy reversing challenge from rootkit researchers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/hacking/ioctl-secrets/" /><meta property="og:image" content="https://i.imgur.com/ZTjHU7a.jpeg" /><meta property="article:section" content="hacking" />

<meta property="og:site_name" content="0xMatheuZ" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://i.imgur.com/ZTjHU7a.jpeg"/>

<meta name="twitter:title" content="Ioctl Secrets Writeup"/>
<meta name="twitter:description" content="Solving an easy reversing challenge from rootkit researchers."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Hackings",
      "item": "http://localhost:1313/hacking/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Ioctl Secrets Writeup",
      "item": "http://localhost:1313/hacking/ioctl-secrets/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ioctl Secrets Writeup",
  "name": "Ioctl Secrets Writeup",
  "description": "Solving an easy reversing challenge from rootkit researchers.",
  "keywords": [
    "CTF"
  ],
  "articleBody": " Challenge Description In this challenge, we’re given access to a Linux virtual machine (VM) running Ubuntu. The objective is to exploit a custom kernel module to retrieve a hidden flag. The challenge involves reverse engineering, kernel internals, and crafting a proper exploit.\nWhat we have:\nA hidden kernel module loaded at boot Character device at /dev/ioctl_dev Setup script (device.sh) that loads the module and shreds source files SSH access enabled (username: root, password: ioctl) Important Note: Many participants had difficulties copy-pasting code directly into the VM console. As stated in the challenge description, SSH is enabled for easier interaction! This was a common pain point, so let’s start by addressing it.\nGetting Started - VM Access \u0026 SSH When you boot the VM, you’ll see the login screen. The credentials are straightforward:\nUsername: root Password: ioctl Setting Up SSH Access After logging in, the first thing you should do is check the VM’s IP address to enable SSH access. This makes the challenge much more comfortable as you can:\nCopy and paste code easily Use multiple terminal windows Access from your preferred terminal emulator Run ip a to get the network configuration:\nAs we can see, the VM has IP 192.168.200.165. Now we can SSH from our host machine:\nssh root@192.168.200.165 Initial Reconnaissance Now that we’re comfortably connected via SSH, let’s explore what we have on the system.\nChecking for the Device The challenge mentions a device at /dev/ioctl_dev. Let’s verify it exists:\nroot@hunter:~# ls -lah /dev/ioctl_dev crw------- 1 root root 237, 0 Nov 9 16:15 /dev/ioctl_dev Perfect! The device exists with:\nType: Character device (c) Permissions: root only Major number: 237 Minor number: 0 Reverse Engineering the Kernel Module Time to analyze the kernel object (device.ko)! I’ll be using binary ninja for this, but Ghidra or IDA work just as well.\nLoading device.ko into binary ninja After loading device.ko into binary ninja and letting it analyze, we can see several interesting functions in the symbol:\nKey functions identified:\nioctl_handler - The main function we need to understand init_module - Module initialization hide - Module hiding functionality cleanup_module - Module cleanup Analyzing ioctl_handler() This is where the magic happens! Let’s examine the decompiled code:\nint64_t ioctl_handler() { int64_t rdx_2; int32_t rsi_3; rdx_2 = __fentry__(); void* gsbase; int64_t rax = *(uint64_t*)((char*)gsbase + 0x28); int32_t var_7c; int32_t var_78; if (rsi_3 == 0xc0487213 \u0026\u0026 !_copy_from_user(\u0026var_7c, rdx_2, 0x48) \u0026\u0026 var_7c == 0x1337dead \u0026\u0026 var_78 == 0xcafebabe) { int64_t var_74; __builtin_strncpy(\u0026var_74, \"ROOTKIT{fake_flag_for_you}\", 0x1b); _copy_to_user(rdx_2, \u0026var_7c, 0x48); } if (rax == *(uint64_t*)((char*)gsbase + 0x28)) return __x86_return_thunk(); __stack_chk_fail(); } findings:\nioctl Command Check: rsi_3 == 0xc0487213\nThis is the ioctl request number we need to use Buffer Size: _copy_from_user(\u0026var_7c, rdx_2, 0x48)\nExpects exactly 0x48 bytes (72 bytes) Magic Value #1: var_7c == 0x1337dead\nFirst 4 bytes must be 0x1337DEAD Magic Value #2: var_78 == 0xcafebabe\nNext 4 bytes must be 0xCAFEBABE Understanding the init_module() Let’s also check how the device gets created:\nint64_t init_module() { __fentry__(); uint32_t rax = __register_chrdev(0, 0, 0x100, \"ioctl_dev\", \u0026fops); major = rax; if (rax \u003e= 0) { uint64_t rax_1 = __class_create(\u0026__this_module, \"ioctl_class\", \u0026__key.2); ioctl_class = rax_1; if (rax_1 \u003c= -0x1000) { uint64_t rax_3 = device_create(rax_1, 0, (uint64_t)(major \u003c\u003c 0x14), 0, \"ioctl_dev\"); __key.2 = rax_3; if (rax_3 \u003c= -0x1000) { hide(); _printk(0x400326); } } } return __x86_return_thunk(); } The device_create() call creates our /dev/ioctl_dev device with:\nDevice class: ioctl_class Device name: ioctl_dev Major number: dynamically allocated (237 in our case) After successful creation, it calls hide() to make the module invisible to lsmod.\nWriting the Exploit Now that we understand the requirements, let’s write our exploit code!\nThe Exploit Create a 72-byte buffer Write 0x1337DEAD at offset 0 Write 0xCAFEBABE at offset 4 Open /dev/ioctl_dev Call ioctl with command 0xc0487213 Read the flag from the returned buffer exploit.c #include #include #include #include #include #include #include int main() { int fd; char buf[0x48]; uint32_t val1 = 0x1337DEAD; uint32_t val2 = 0xCAFEBABE; memset(buf, 0, sizeof(buf)); *(uint32_t*)buf = val1; *(uint32_t*)(buf + 4) = val2; fd = open(\"/dev/ioctl_dev\", O_RDWR); if (fd \u003c 0) { perror(\"open\"); return 1; } if (ioctl(fd, 0xc0487213, buf) \u003c 0) { perror(\"ioctl\"); close(fd); return 1; } printf(\"Flag: %s\\n\", buf); close(fd); return 0; } Compiling and Running Since we’re connected via SSH, we can easily copy the code and compile it:\nroot@hunter:~# gcc exploit.c -o exploit root@hunter:~# ./exploit Flag: ROOTKIT{ioctl_secret_unlocked@1337} Success! We’ve captured the flag!\nWhy It Works The exploit works because the kernel module uses the same buffer for both receiving input and sending output. We create a 72-byte buffer (buf[0x48]), write the magic values 0x1337DEAD and 0xCAFEBABE at the beginning using pointer casting ((uint32_t)buf), then open the device and call ioctl() with command 0xc0487213.\nThe kernel validates our magic values with _copy_from_user(), and if they match, uses _copy_to_user() with the same pointer to overwrite our buffer with the flag.\nKey Lessons Learned 1. Check dmesg for Kernel Activity Kernel messages provided crucial information about module loading and potential issues.\n2. Understand ioctl Communication The ioctl interface is a powerful way for userspace to communicate with kernel drivers. Understanding the command numbers and data structures is essential.\n3. Reversing Skills Being comfortable with tools like Ghidra, IDA, or Binary Ninja is crucial for kernel module analysis.\nConclusion This challenge was an excellent introduction to Reversing and you can learn:\nLinux kernel modules Reverse engineering Crafting ioctl requests Recognizing rootkit techniques Our Community Join the Rootkit Researchers community:\nDiscord Server\nChallenge created by Matheuz - Have fun guys!!\nThanks for reading! If you enjoyed this writeup, consider sharing it with others who might find it useful. Happy hacking!\n",
  "wordCount" : "931",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "0xMatheuZ"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/hacking/ioctl-secrets/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "0xMatheuZ",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="MatheuZ (Alt + H)">
                <img src="https://i.imgur.com/xeSd64L.png" alt="" aria-label="logo"
                    height="25">MatheuZ</a>
            <div class="logo-switches">
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/hacking" title="hacking">
                    <span>hacking</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/hacking/">Hackings</a></div>
    <h1 class="post-title entry-hint-parent">
      Ioctl Secrets Writeup
    </h1>
    <div class="post-description">
      Solving an easy reversing challenge from rootkit researchers.
    </div>
    <div class="post-meta">5 min&nbsp;·&nbsp;0xMatheuZ

</div>
  </header> 
  <div class="post-content"><p><img loading="lazy" src="https://i.imgur.com/ZTjHU7a.jpeg" alt="img"  />
</p>
<hr>
<h2 id="challenge-description">Challenge Description<a hidden class="anchor" aria-hidden="true" href="#challenge-description">#</a></h2>
<p>In this challenge, we&rsquo;re given access to a Linux virtual machine (VM) running Ubuntu. The objective is to exploit a custom kernel module to retrieve a hidden flag. The challenge involves reverse engineering, kernel internals, and crafting a proper exploit.</p>
<p><strong>What we have:</strong></p>
<ul>
<li>A hidden kernel module loaded at boot</li>
<li>Character device at <code>/dev/ioctl_dev</code></li>
<li>Setup script (<code>device.sh</code>) that loads the module and shreds source files</li>
<li>SSH access enabled (username: <code>root</code>, password: <code>ioctl</code>)</li>
</ul>
<p><strong>Important Note:</strong> Many participants had difficulties copy-pasting code directly into the VM console. As stated in the challenge description, <strong>SSH is enabled</strong> for easier interaction! This was a common pain point, so let&rsquo;s start by addressing it.</p>
<hr>
<h2 id="getting-started---vm-access--ssh">Getting Started - VM Access &amp; SSH<a hidden class="anchor" aria-hidden="true" href="#getting-started---vm-access--ssh">#</a></h2>
<p>When you boot the VM, you&rsquo;ll see the login screen. The credentials are straightforward:</p>
<ul>
<li><strong>Username:</strong> <code>root</code></li>
<li><strong>Password:</strong> <code>ioctl</code></li>
</ul>
<h3 id="setting-up-ssh-access">Setting Up SSH Access<a hidden class="anchor" aria-hidden="true" href="#setting-up-ssh-access">#</a></h3>
<p>After logging in, the first thing you should do is check the VM&rsquo;s IP address to enable SSH access. This makes the challenge much more comfortable as you can:</p>
<ul>
<li>Copy and paste code easily</li>
<li>Use multiple terminal windows</li>
<li>Access from your preferred terminal emulator</li>
</ul>
<p>Run <code>ip a</code> to get the network configuration:</p>
<p>As we can see, the VM has IP <code>192.168.200.165</code>. Now we can SSH from our host machine:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh root@192.168.200.165
</span></span></code></pre></div><p><img loading="lazy" src="https://i.imgur.com/HjDAVom.png" alt="SSH Connection"  />
</p>
<hr>
<h2 id="initial-reconnaissance">Initial Reconnaissance<a hidden class="anchor" aria-hidden="true" href="#initial-reconnaissance">#</a></h2>
<p>Now that we&rsquo;re comfortably connected via SSH, let&rsquo;s explore what we have on the system.</p>
<h3 id="checking-for-the-device">Checking for the Device<a hidden class="anchor" aria-hidden="true" href="#checking-for-the-device">#</a></h3>
<p>The challenge mentions a device at <code>/dev/ioctl_dev</code>. Let&rsquo;s verify it exists:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@hunter:~# ls -lah /dev/ioctl_dev
</span></span><span class="line"><span class="cl">crw------- <span class="m">1</span> root root 237, <span class="m">0</span> Nov <span class="m">9</span> 16:15 /dev/ioctl_dev
</span></span></code></pre></div><p><img loading="lazy" src="https://i.imgur.com/6NkOMLc.png" alt="Device File"  />
</p>
<p>Perfect! The device exists with:</p>
<ul>
<li><strong>Type:</strong> Character device (<code>c</code>)</li>
<li><strong>Permissions:</strong> root only</li>
<li><strong>Major number:</strong> 237</li>
<li><strong>Minor number:</strong> 0</li>
</ul>
<h2 id="reverse-engineering-the-kernel-module">Reverse Engineering the Kernel Module<a hidden class="anchor" aria-hidden="true" href="#reverse-engineering-the-kernel-module">#</a></h2>
<p>Time to analyze the kernel object (device.ko)! I&rsquo;ll be using binary ninja for this, but Ghidra or IDA work just as well.</p>
<h3 id="loading-deviceko-into-binary-ninja">Loading device.ko into binary ninja<a hidden class="anchor" aria-hidden="true" href="#loading-deviceko-into-binary-ninja">#</a></h3>
<p>After loading <code>device.ko</code> into binary ninja and letting it analyze, we can see several interesting functions in the symbol:</p>
<p>Key functions identified:</p>
<ul>
<li><code>ioctl_handler</code> - The main function we need to understand</li>
<li><code>init_module</code> - Module initialization</li>
<li><code>hide</code> - Module hiding functionality</li>
<li><code>cleanup_module</code> - Module cleanup</li>
</ul>
<h3 id="analyzing-ioctl_handler">Analyzing ioctl_handler()<a hidden class="anchor" aria-hidden="true" href="#analyzing-ioctl_handler">#</a></h3>
<p>This is where the magic happens! Let&rsquo;s examine the decompiled code:</p>
<p><img loading="lazy" src="https://i.imgur.com/bipyxZi.png" alt="ioctl_handler Code"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int64_t</span> <span class="nf">ioctl_handler</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">rdx_2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">rsi_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rdx_2</span> <span class="o">=</span> <span class="nf">__fentry__</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">gsbase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">rax</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">gsbase</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">var_7c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32_t</span> <span class="n">var_78</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rsi_3</span> <span class="o">==</span> <span class="mh">0xc0487213</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="nf">_copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var_7c</span><span class="p">,</span> <span class="n">rdx_2</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">var_7c</span> <span class="o">==</span> <span class="mh">0x1337dead</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">var_78</span> <span class="o">==</span> <span class="mh">0xcafebabe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">var_74</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">__builtin_strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var_74</span><span class="p">,</span> <span class="s">&#34;ROOTKIT{fake_flag_for_you}&#34;</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">_copy_to_user</span><span class="p">(</span><span class="n">rdx_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var_7c</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rax</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">gsbase</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">__x86_return_thunk</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>findings:</strong></p>
<ol>
<li>
<p><strong>ioctl Command Check:</strong> <code>rsi_3 == 0xc0487213</code></p>
<ul>
<li>This is the ioctl request number we need to use</li>
</ul>
</li>
<li>
<p><strong>Buffer Size:</strong> <code>_copy_from_user(&amp;var_7c, rdx_2, 0x48)</code></p>
<ul>
<li>Expects exactly <code>0x48</code> bytes (72 bytes)</li>
</ul>
</li>
<li>
<p><strong>Magic Value #1:</strong> <code>var_7c == 0x1337dead</code></p>
<ul>
<li>First 4 bytes must be <code>0x1337DEAD</code></li>
</ul>
</li>
<li>
<p><strong>Magic Value #2:</strong> <code>var_78 == 0xcafebabe</code></p>
<ul>
<li>Next 4 bytes must be <code>0xCAFEBABE</code></li>
</ul>
</li>
</ol>
<h3 id="understanding-the-init_module">Understanding the init_module()<a hidden class="anchor" aria-hidden="true" href="#understanding-the-init_module">#</a></h3>
<p>Let&rsquo;s also check how the device gets created:</p>
<p><img loading="lazy" src="https://i.imgur.com/GSLBhPr.png" alt="init_module Code"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int64_t</span> <span class="nf">init_module</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__fentry__</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">rax</span> <span class="o">=</span> <span class="nf">__register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="s">&#34;ioctl_dev&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">major</span> <span class="o">=</span> <span class="n">rax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rax</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint64_t</span> <span class="n">rax_1</span> <span class="o">=</span> <span class="nf">__class_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__this_module</span><span class="p">,</span> <span class="s">&#34;ioctl_class&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__key</span><span class="mf">.2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ioctl_class</span> <span class="o">=</span> <span class="n">rax_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rax_1</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint64_t</span> <span class="n">rax_3</span> <span class="o">=</span> <span class="nf">device_create</span><span class="p">(</span><span class="n">rax_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="n">major</span> <span class="o">&lt;&lt;</span> <span class="mh">0x14</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;ioctl_dev&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">__key</span><span class="mf">.2</span> <span class="o">=</span> <span class="n">rax_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">rax_3</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">hide</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="nf">_printk</span><span class="p">(</span><span class="mh">0x400326</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">__x86_return_thunk</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>device_create()</code> call creates our <code>/dev/ioctl_dev</code> device with:</p>
<ul>
<li>Device class: <code>ioctl_class</code></li>
<li>Device name: <code>ioctl_dev</code></li>
<li>Major number: dynamically allocated (237 in our case)</li>
</ul>
<p>After successful creation, it calls <code>hide()</code> to make the module invisible to <code>lsmod</code>.</p>
<hr>
<h2 id="writing-the-exploit">Writing the Exploit<a hidden class="anchor" aria-hidden="true" href="#writing-the-exploit">#</a></h2>
<p>Now that we understand the requirements, let&rsquo;s write our exploit code!</p>
<h3 id="the-exploit">The Exploit<a hidden class="anchor" aria-hidden="true" href="#the-exploit">#</a></h3>
<ol>
<li>Create a 72-byte buffer</li>
<li>Write <code>0x1337DEAD</code> at offset 0</li>
<li>Write <code>0xCAFEBABE</code> at offset 4</li>
<li>Open <code>/dev/ioctl_dev</code></li>
<li>Call ioctl with command <code>0xc0487213</code></li>
<li>Read the flag from the returned buffer</li>
</ol>
<h3 id="exploitc">exploit.c<a hidden class="anchor" aria-hidden="true" href="#exploitc">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x48</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">val1</span> <span class="o">=</span> <span class="mh">0x1337DEAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">val2</span> <span class="o">=</span> <span class="mh">0xCAFEBABE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">=</span> <span class="n">val1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">val2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/ioctl_dev&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0xc0487213</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;ioctl&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Flag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="compiling-and-running">Compiling and Running<a hidden class="anchor" aria-hidden="true" href="#compiling-and-running">#</a></h3>
<p>Since we&rsquo;re connected via SSH, we can easily copy the code and compile it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@hunter:~# gcc exploit.c -o exploit
</span></span><span class="line"><span class="cl">root@hunter:~# ./exploit
</span></span></code></pre></div><p><img loading="lazy" src="https://i.imgur.com/uRb9EAY.png" alt="Exploit Execution"  />
</p>
<pre tabindex="0"><code>Flag: ROOTKIT{ioctl_secret_unlocked@1337}
</code></pre><p><strong>Success!</strong> We&rsquo;ve captured the flag!</p>
<h3 id="why-it-works">Why It Works<a hidden class="anchor" aria-hidden="true" href="#why-it-works">#</a></h3>
<p>The exploit works because the kernel module uses the same buffer for both receiving input and sending output. We create a 72-byte buffer (buf[0x48]), write the magic values 0x1337DEAD and 0xCAFEBABE at the beginning using pointer casting (<em>(uint32_t</em>)buf), then open the device and call ioctl() with command 0xc0487213.</p>
<p>The kernel validates our magic values with _copy_from_user(), and if they match, uses _copy_to_user() with the same pointer to overwrite our buffer with the flag.</p>
<hr>
<h2 id="key-lessons-learned">Key Lessons Learned<a hidden class="anchor" aria-hidden="true" href="#key-lessons-learned">#</a></h2>
<h3 id="1-check-dmesg-for-kernel-activity">1. Check dmesg for Kernel Activity<a hidden class="anchor" aria-hidden="true" href="#1-check-dmesg-for-kernel-activity">#</a></h3>
<p>Kernel messages provided crucial information about module loading and potential issues.</p>
<h3 id="2-understand-ioctl-communication">2. Understand ioctl Communication<a hidden class="anchor" aria-hidden="true" href="#2-understand-ioctl-communication">#</a></h3>
<p>The ioctl interface is a powerful way for userspace to communicate with kernel drivers. Understanding the command numbers and data structures is essential.</p>
<h3 id="3-reversing-skills">3. Reversing Skills<a hidden class="anchor" aria-hidden="true" href="#3-reversing-skills">#</a></h3>
<p>Being comfortable with tools like Ghidra, IDA, or Binary Ninja is crucial for kernel module analysis.</p>
<hr>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>This challenge was an excellent introduction to Reversing and you can learn:</p>
<ul>
<li>Linux kernel modules</li>
<li>Reverse engineering</li>
<li>Crafting ioctl requests</li>
<li>Recognizing rootkit techniques</li>
</ul>
<hr>
<h2 id="our-community">Our Community<a hidden class="anchor" aria-hidden="true" href="#our-community">#</a></h2>
<p>Join the <strong>Rootkit Researchers</strong> community:<br>
<a href="https://discord.gg/66N5ZOpqU7">Discord Server</a></p>
<p><em>Challenge created by Matheuz - Have fun guys!!</em></p>
<hr>
<p><strong>Thanks for reading! If you enjoyed this writeup, consider sharing it with others who might find it useful. Happy hacking!</strong></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/ctf/">CTF</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/hacking/ldpreload-rootkit/">
    <span class="title">« Prev</span>
    <br>
    <span>How detect a LD_PRELOAD rootkit and hide from ldd &amp; /proc</span>
  </a>
  <a class="next" href="http://localhost:1313/hacking/linux-threat-hunting-persistence/">
    <span class="title">Next »</span>
    <br>
    <span>Linux Threat Hunting Persistence</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="http://localhost:1313/">0xMatheuZ</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
